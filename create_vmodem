#!/bin/bash
# part of insulaudit-ssh-tools

echo $0
config=${1}

function do_socat ( ) {
  vmodem=${VMODEM-$WORK_BASE/vmodem}
  port=$(git config -f $WORK_CONF/audit.config --get serialtonet.port)
  baud=$(git config -f $WORK_CONF/audit.config --get serialtonet.baud || echo 9600)
  echo socat TCP-L:$port,reuseaddr pty,link=$vmodem,b${baud},raw
  exec  socat -d -d \
        pty,link=$vmodem,b${baud},waitslave,raw \
        TCP:localhost:$port 
}

( do_socat || echo "SOCAT DIED" ) &
echo "XXX:" $$
echo "XXX:" $_
export SOCAT_PID=$!
echo socat pid: $SOCAT_PID
sleep 2
echo "WHO IS USING $VMODEM"
lsof $VMODEM

#####
# EOF
